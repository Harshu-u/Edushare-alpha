{% extends 'base/base.html' %}

{% block content %}
<div class="card p-4">
  <h2>{{ note.title }}</h2>
  <p>By: {{ note.uploader.username }}</p>
  <p>Category: {{ note.category.name }}</p>
  <p>Average Rating: {{ note.average_rating|default:0 }} ({{ note.total_ratings }})</p>

  <div>
    <a href="{{ note.file.url }}" class="btn btn-outline-primary" target="_blank">Download / Preview</a>
  </div>

  {% if user.is_authenticated %}
    <div id="rating-widget" class="mt-3">
      <label class="d-block mb-2">Rate this note:</label>
      <div id="stars" data-note-id="{{ note.pk }}">
        {% for i in '12345' %}
          {% comment %} simple star buttons - i is char '1'..'5' {% endcomment %}
          <button class="star btn btn-light" data-value="{{ forloop.counter }}">&#9733;</button>
        {% endfor %}
      </div>
      <div id="rating-feedback" class="mt-2 text-muted">Average: <span id="avg">{{ note.average_rating|default:0 }}</span> (<span id="count">{{ note.total_ratings }}</span>)</div>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    const stars = document.querySelectorAll('#stars .star');
    const noteId = document.getElementById('stars')?.dataset?.noteId;
    const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]')?.value;

    if(!noteId) return;

    stars.forEach(s => {
      s.addEventListener('click', async function(e){
        const value = this.dataset.value;
        try{
          const res = await fetch(`/notes/${noteId}/rate/`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': csrfToken
            },
            body: new URLSearchParams({rating: value})
          });
          if(res.ok){
            const data = await res.json();
            document.getElementById('avg').innerText = parseFloat(data.average_rating).toFixed(1);
            document.getElementById('count').innerText = data.total_ratings;
            // visual feedback
            stars.forEach(st => st.classList.remove('btn-warning'));
            for(let i=0;i<value;i++){ stars[i].classList.add('btn-warning'); }
          } else {
            const err = await res.json();
            alert(err.error || 'Could not submit rating');
          }
        }catch(err){
          console.error(err); alert('Network error');
        }
      })
    })
  })();
</script>
{% endblock %}
